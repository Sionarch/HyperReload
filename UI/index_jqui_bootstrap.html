<!DOCTYPE html>
<html>
	<!-- HTML 5 differences from HTML 4: http://www.w3.org/TR/2008/WD-html5-diff-20080122/ -->
<head>
    <meta charset="utf-8">
    
    <title>HyperApp</title>
    
    <link href="libs/jquery-ui-bootstrap-0.5/assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="libs/jquery-ui-bootstrap-0.5/css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
            
    <script src="libs/jquery/jquery-2.0.3.min.js"></script>
	<scriptx src="libs/jquery-ui-bootstrap-0.5/assets/js/jquery-1.9.0.min.js"></scriptx>
	<script src="libs/jquery-ui-bootstrap-0.5/assets/js/bootstrap.min.js"></script>
	<script src="libs/jquery-ui-bootstrap-0.5/assets/js/jquery-ui-1.10.0.custom.min.js"></script>

    <style>
    body
    {
        font-family: sans-serif;
    }
    /*
	#panel-open-tools
    {
		width: 100%;
    }
	#button-workbench, #button-documentation
    {
		width: 45%;
    }
    #button-reload
    {
		width: 100%;
        height: 80px;
        font-size: 40px;
    }
    */
    #panel-path
    {
		margin: 20px 0px;
		width: 100%;
        font-size: 18px;
    }
    #field-app-path
    {
		width: 100%;
        font-size: 18px;
    }
    #button-set-app-path
    {
		width: 100%;
        font-size: 18px;
    }
    
    #panel-projects.non-hover { background: blue; }
	#panel-projects.hover { background: red; }
	
	#drag-overlay
	{
		position: absolute;
		left: 0px;
		top: 0px;
		margin: 0px;
		width: 100%;
		height: 100%;
		background-color: rgba(100,255,100,0.0);
		display: none;
	}
	
	#drag-overlay h1
	{
		position: absolute;
		left: 40px;
		top: 40px;
		right: 40px;
		padding: 20px;
		border: 1px solid #000000;
		background-color: rgba(255,255,255,0.7);
	}
	
	#panel-page
	{
		margin: 0;
		padding: 0;
		width: 100%;
		height: 100%;
	}
	
	#panel-top
	{
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 36px;
	}
	
	#panel-middle
	{
		position: absolute;
		left: 0;
		top: 36px;
		bottom: 82px;
		width: 100%;
		overflow: auto;
	}
	
	#panel-bottom
	{
		position: absolute;
		left: 0;
		bottom: 0px;
		width: 100%;
		height: 80px;
		background-color: rgba(200,200,200,1);
	}
	
	#panel-tool-buttons
	{
		width: 100%;
	}
	
	#button-workbench, #button-documentation, #button-quick-start
    {
		width: 33.33%;
		height: 36px;
		font-size: 18px;
		font-weight: bold;
    }
    </style>
    
</head>
<body>
	<div id="panel-page">
		
		<div id="panel-top">
			<div id="panel-tool-buttons" class="btn-group">
				<button id="button-workbench" type="button" class="btn btn-primary">Workbench</button>
				<button id="button-documentation" type="button" class="btn btn-success">Documentation</button>
				<button id="button-quick-start" type="button" class="btn btn-danger">Quick-Start</button>
			</div>
		</div>
		
		<style>
		#sortable
		{
			position: relative;
			margin: 0; 
			padding: 0;
			width: 100%;
		}
		#sortable div 
		{ 
			position: relative;
			margin: 5px; 
			padding: 0 10px;
			min-height: 40px;
			border: 1px solid #000000;
		}
		#sortable div span
		{
			position: absolute;
			right: 10px; 
		}
		</style>
		
		<script>
		$(function() {
			$( "#sortable" ).sortable()
			$( "#sortable" ).disableSelection()
		})
		</script>

		<div id="panel-middle">
			<div id="sortable">
				<div class="ui-state-default ui-corner-all">
					<button style="position:absolute;right:10px;top:10px;bottom:10px;width:100px;font-weight: bold;" 
					id="button-x" type="button" class="btn btn-primary">Run App</button>
					<h4>Hello World</h4>
					<p>/file/path/index.html</p>
				</div>
				<div class="ui-state-default ui-corner-all">
					<button style="position:absolute;right:10px;top:10px;bottom:10px;width:100px;font-weight: bold;" 
					id="button-x" type="button" class="btn btn-primary">Run App</button>
					<h4><a href="javascript:alert('hello')">Canvas Demo</a></h4>
					<p>/file/path/index.html</p>
				</div>
				<div class="ui-state-default ui-corner-all">
					<h4>Tip: Drag and drop HTML files here to add them to the project list</h4>
				</div>
				<!--
				<div class="ui-state-default">Item 2<span id="xdiv"><a href="#">Hello</a></span></div>
				-->
			</div>
		</div>

		<div id="panel-bottom">
			<div style="padding:10px;">
				<p>Address for the HyperApp mobile app: <b>127.0.0.1</b></p>
				<p>Address to connect from a browser: <b>http://127.0.0.1/connect</b></p>
			</div>
		</div>

		<div id="drag-overlay">
			<h1 class="ui-corner-all">Drop HTML file here to add it to the project list. 
			[also say how to remove an item]</h1>
		</div>

	</div> <!-- panel-page -->
	
	<script>
	// UI setup.
	;(function()
	{
		function setupUI()
		{
			styleUI()
			setUIActions()
			setUpFileDrop()
		}
		
		function styleUI()
		{
			// Apply jQuery UI button style.
			//$('button').button()
			
			// Set layout properties.
			/*
			$('body').layout(
			{ 
				west: { size: 400 },
				center: { maskContents: true },
				fxName: 'none'
			})
			*/
		}
		
		function setUpFileDrop()
		{
			var originalDropTaget = null
			
			// Block change page on drop.
			window.ondragover = function(e) { e.preventDefault(); return false }
			window.ondragend = function(e) { e.preventDefault(); return false }
			window.ondrop = function(e) { e.preventDefault(); return false }

			// Set up drop handling using a drop target overlay area.
			var dropTarget = $('#panel-page')
			dropTarget.on('dragenter', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').show();
			})
			$('#drag-overlay').on('dragleave dragend', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
			})
			$('#drag-overlay').on('drop', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
				var files = e.originalEvent.dataTransfer.files
				setAppPath(files[0].path)
				for (var i = 0; i < files.length; ++i) 
				{
					// TODO: Add this file to the UI
					console.log(files[i].path);
				}
			})
		}
		
		function setUIActions()
		{
			// Set app path button action.
			/*$('#button-set-app-path').click(function()
			{
				updateAppPath()
			})*/

			// Reload button action.
			$('#button-reload').click(function()
			{
				updateAppPath()
				SERVER.sendReload()
			})
			
			/*
			// Workbench button action.
			$('#button-workbench').click(function()
			{
				var workbench = window.open(
					'workbench.html', 
					'workbench',
					'resizable=1,width=800,height=600')
				workbench.moveTo(0, 0)
			})
			*/
		}

		setupUI()
	})()
	
	</script>
	
	<script>
	// Server set up.
	// TODO: Remove hard coded port numbers below and
	// in reload.js.
	;(function()
	{
		var SERVER = require('./server.js')
		var FS = require('fs')

		var mSavedAppPath = './app-path.txt'

		function setupServer()
		{
			SERVER.startServers()
			SERVER.setTraverseNumDirectoryLevels(0)
			SERVER.fileSystemMonitor()
			//styleUI()
			//setUIActions()
			//setUpFileDrop()
			readSavedAppPath()
			displayServerIpAddress()
		}
		
		function displayServerIpAddress()
		{
			SERVER.getWebServerIpAndPort(function(ip, port) {
				document.querySelector('#server-ip').innerHTML = 
					'http://' + ip + ':' + port + '/connect'
			})
		}
		
		function styleUI()
		{
			// Apply jQuery UI button style.
			$('button').button()
			
			// Set layout properties.
			$('body').layout(
			{ 
				west: { size: 400 },
				center: { maskContents: true },
				fxName: 'none'
			})
		}
		
		function setUpFileDrop()
		{
			var originalDropTaget = null
			
			// Block change page on drop.
			window.ondragover = function(e) { e.preventDefault(); return false }
			window.ondragend = function(e) { e.preventDefault(); return false }
			window.ondrop = function(e) { e.preventDefault(); return false }

			// Set up drop handling using a drop target overlay area.
			var dropTarget = $('#panel-projects')
			dropTarget.on('dragenter', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').show();
			})
			$('#drag-overlay').on('dragleave dragend', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
			})
			$('#drag-overlay').on('drop', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
				var files = e.originalEvent.dataTransfer.files
				setAppPath(files[0].path)
				for (var i = 0; i < files.length; ++i) 
				{
					// TODO: Add this file to the UI
					console.log(files[i].path);
				}
			})
		}
		
		function setUIActions()
		{
			// Set app path button action.
			/*$('#button-set-app-path').click(function()
			{
				updateAppPath()
			})*/

			// Reload button action.
			$('#button-reload').click(function()
			{
				updateAppPath()
				SERVER.sendReload()
			})
			
			/*
			// Workbench button action.
			$('#button-workbench').click(function()
			{
				var workbench = window.open(
					'workbench.html', 
					'workbench',
					'resizable=1,width=800,height=600')
				workbench.moveTo(0, 0)
			})
			*/
		}
		
		function readSavedAppPath()
		{
			if (FS.existsSync(mSavedAppPath))
			{
				var appPath = FS.readFileSync(mSavedAppPath, {encoding: 'utf8'})
				setAppPath(appPath)
			}
		}

		function updateAppPath()
		{
			var appPath = document.querySelector('#field-app-path').value
			setAppPath(appPath)
		}
		
		function setAppPath(appPath)
		{
			SERVER.setAppPath(appPath)
			FS.writeFileSync(mSavedAppPath, appPath, {encoding: 'utf8'})
			document.querySelector('#field-app-path').value = appPath
		}

		// Display version info.
		//document.querySelector('#info').innerHTML = 'node.js ' + process.version

		setupServer()
	})()
	</script>
</body>
</html>
