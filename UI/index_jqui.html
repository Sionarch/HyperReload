<!DOCTYPE html>
<html>
	<!-- HTML 5 differences from HTML 4: http://www.w3.org/TR/2008/WD-html5-diff-20080122/ -->
<head>
    <meta charset="utf-8">
    
    <title>HyperApp</title>
    
    <link rel="stylesheet" href="libs/jquery/themes/sunny/jquery-ui.min.css" />
    <link rel="stylesheet" href="libs/jquery/layout-default-latest.css" />
        
    <script src="libs/jquery/jquery-2.0.3.min.js"></script>
    <script src="libs/jquery/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="libs/jquery/jquery.layout-latest.min.js"></script>
    
    <style>
    body
    {
        font-family: sans-serif;
    }
    
	#panel-open-tools
    {
		width: 100%;
    }
	
	#button-workbench, #button-documentation
    {
		width: 45%;
    }
    
    #button-reload
    {
		width: 100%;
        height: 80px;
        font-size: 40px;
    }
    #panel-path
    {
		margin: 20px 0px;
		width: 100%;
        font-size: 18px;
    }
    #field-app-path
    {
		width: 100%;
        font-size: 18px;
    }
    #button-set-app-path
    {
		width: 100%;
        font-size: 18px;
    }
    
    #panel-projects.non-hover { background: blue; }
	#panel-projects.hover { background: red; }
	
	#drag-overlay
	{
		position: absolute;
		left: 0px;
		top: 0px;
		margin: 0px;
		width: 100%;
		height: 100%;
		background-color: rgba(100,255,100,0.3);
		display: none;
	}
    </style>
    
</head>
<body>
	<div id="panel-projects">
	
		<div id="panel-open-tools">
			<button id="button-workbench">Workbench</button>
			<button id="button-documentation">Documentation</button>
		</div>
		
		<div id="panel-reload">
			<button id="button-reload">Run App</button>
		</div>
		
		<div id="panel-path">
			Main HTML File:<br/>
			<input type="text" id="field-app-path" value=""><br/>
			<!-- <button id="button-set-app-path">Set App Path</button><br/> -->
		</div>
		
		<h3 id="server-ip"></h3>
		
		<div id="drag-overlay"></div>
		</div> 
	
	</div>
	
	<script>
	// UI setup.
	;(function()
	{
		function setupUI()
		{
			styleUI()
			setUIActions()
			setUpFileDrop()
		}
		
		function styleUI()
		{
			// Apply jQuery UI button style.
			$('button').button()
			
			// Set layout properties.
			/*
			$('body').layout(
			{ 
				west: { size: 400 },
				center: { maskContents: true },
				fxName: 'none'
			})
			*/
		}
		
		function setUpFileDrop()
		{
			var originalDropTaget = null
			
			// Block change page on drop.
			window.ondragover = function(e) { e.preventDefault(); return false }
			window.ondragend = function(e) { e.preventDefault(); return false }
			window.ondrop = function(e) { e.preventDefault(); return false }

			// Set up drop handling using a drop target overlay area.
			var dropTarget = $('#panel-projects')
			dropTarget.on('dragenter', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').show();
			})
			$('#drag-overlay').on('dragleave dragend', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
			})
			$('#drag-overlay').on('drop', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
				var files = e.originalEvent.dataTransfer.files
				setAppPath(files[0].path)
				for (var i = 0; i < files.length; ++i) 
				{
					// TODO: Add this file to the UI
					console.log(files[i].path);
				}
			})
		}
		
		function setUIActions()
		{
			// Set app path button action.
			/*$('#button-set-app-path').click(function()
			{
				updateAppPath()
			})*/

			// Reload button action.
			$('#button-reload').click(function()
			{
				updateAppPath()
				SERVER.sendReload()
			})
			
			/*
			// Workbench button action.
			$('#button-workbench').click(function()
			{
				var workbench = window.open(
					'workbench.html', 
					'workbench',
					'resizable=1,width=800,height=600')
				workbench.moveTo(0, 0)
			})
			*/
		}

		setupUI()
	})()
	
	</script>
	
	<script>
	// Server set up.
	// TODO: Remove hard coded port numbers below and
	// in reload.js.
	;(function()
	{
		var SERVER = require('./server.js')
		var FS = require('fs')

		var mSavedAppPath = './app-path.txt'

		function setupServer()
		{
			SERVER.startServers()
			SERVER.setTraverseNumDirectoryLevels(0)
			SERVER.fileSystemMonitor()
			//styleUI()
			//setUIActions()
			//setUpFileDrop()
			readSavedAppPath()
			displayServerIpAddress()
		}
		
		function displayServerIpAddress()
		{
			SERVER.getWebServerIpAndPort(function(ip, port) {
				document.querySelector('#server-ip').innerHTML = 
					'http://' + ip + ':' + port + '/connect'
			})
		}
		
		function styleUI()
		{
			// Apply jQuery UI button style.
			$('button').button()
			
			// Set layout properties.
			$('body').layout(
			{ 
				west: { size: 400 },
				center: { maskContents: true },
				fxName: 'none'
			})
		}
		
		function setUpFileDrop()
		{
			var originalDropTaget = null
			
			// Block change page on drop.
			window.ondragover = function(e) { e.preventDefault(); return false }
			window.ondragend = function(e) { e.preventDefault(); return false }
			window.ondrop = function(e) { e.preventDefault(); return false }

			// Set up drop handling using a drop target overlay area.
			var dropTarget = $('#panel-projects')
			dropTarget.on('dragenter', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').show();
			})
			$('#drag-overlay').on('dragleave dragend', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
			})
			$('#drag-overlay').on('drop', function(e) 
			{
				e.stopPropagation()
				e.preventDefault()
				$('#drag-overlay').hide();
				var files = e.originalEvent.dataTransfer.files
				setAppPath(files[0].path)
				for (var i = 0; i < files.length; ++i) 
				{
					// TODO: Add this file to the UI
					console.log(files[i].path);
				}
			})
		}
		
		function setUIActions()
		{
			// Set app path button action.
			/*$('#button-set-app-path').click(function()
			{
				updateAppPath()
			})*/

			// Reload button action.
			$('#button-reload').click(function()
			{
				updateAppPath()
				SERVER.sendReload()
			})
			
			/*
			// Workbench button action.
			$('#button-workbench').click(function()
			{
				var workbench = window.open(
					'workbench.html', 
					'workbench',
					'resizable=1,width=800,height=600')
				workbench.moveTo(0, 0)
			})
			*/
		}
		
		function readSavedAppPath()
		{
			if (FS.existsSync(mSavedAppPath))
			{
				var appPath = FS.readFileSync(mSavedAppPath, {encoding: 'utf8'})
				setAppPath(appPath)
			}
		}

		function updateAppPath()
		{
			var appPath = document.querySelector('#field-app-path').value
			setAppPath(appPath)
		}
		
		function setAppPath(appPath)
		{
			SERVER.setAppPath(appPath)
			FS.writeFileSync(mSavedAppPath, appPath, {encoding: 'utf8'})
			document.querySelector('#field-app-path').value = appPath
		}

		// Display version info.
		//document.querySelector('#info').innerHTML = 'node.js ' + process.version

		setupServer()
	})()
	</script>
</body>
</html>
