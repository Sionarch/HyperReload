<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HyperApp Workbench</title>
<link rel="stylesheet" href="css/dsedit.css" />

<script>
function receiveMessage(event)
{
  console.log('I got : ' + event.data)
  window.parent.postMessage('pingback', '*')
}
window.addEventListener('message', receiveMessage, false)

</script>


<scriptx src="js/jquery-1.4.2.min.js"></scriptx>
<scriptx src="js/jquery-ui-1.8.custom.min.js"></scriptx>
<scriptx src="js/jquery.layout-latest.js"></scriptx>
<scriptx src="js/CodeMirror/js/codemirror.js"></scriptx>

<scriptx>
$(document).ready(function() 
{
    var editor = CodeMirror.fromTextArea("codeeditor", 
    {
        parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
        path: "js/CodeMirror/js/",
        stylesheet: "js/CodeMirror/css/jscolors.css",
        height: "100%",
        width: "100%",
        indentUnit: 4,
        autoMatchParens: true
        // lineNumbers: true
    });
    
    var result = CodeMirror.fromTextArea("resulteditor",
    {
        parserfile: ["tokenizejavascript.js", "parsejavascript.js"],
        path: "js/CodeMirror/js/",
        stylesheet: "js/CodeMirror/css/jscolors.css",
        height: "100%",
        width: "100%"
    });    

    $("input.buttonEval").click(function() 
    {
        var code = editor.selection(); //.getCode();
        var ipaddress = getDeviceIpAddress();
        var res = sendToDevice("eval", code, ipaddress);
        showResult(res);
    });

    $("input.buttonRunActivity").click(function() 
    {
        var code = editor.selection(); //.getCode();
        var ipaddress = getDeviceIpAddress();
        var res = sendToDevice("run", code, ipaddress);
        showResult(res);
    });

    $("input.buttonIndentSelection").click(function() 
    {
        editor.reindentSelection(); 
    });
    
    $("input.buttonUndo").click(function() 
    {
        editor.undo(); 
    });

    $("input.buttonRedo").click(function() 
    {
        editor.redo(); 
    });
    
    $("input.buttonClearResult").click(function() 
    {
        result.setCode(""); 
    });

    $("input.buttonEvalInBrowser").click(function() 
    {
        try {
            var code = editor.selection();
            var res = eval(code);
            showResult(res); }
        catch (error) {
             showResult("{*.*} " + error); }
    });
    
    function getDeviceIpAddress()
    {
        return jQuery.trim($("input.ipaddress").val());
    }
    
    function showResult(res)
    {
        result.setCode(res + "\n" + result.getCode()); 
    }

    function sendToDevice(action, code, ipaddress) 
    {
        var result = "[*_*] Cannot communicate with the device!";
        try
        {
            var deviceUrl = "http://" + ipaddress + ":4042/" + action + "/";
            var response = $.ajax(
            {
                url: deviceUrl,
                type: "PUT",
                data: code,
                processData: false,
                dataType: "text/plain",
                async: false,
                timeout: 5000,
                success: function(data)
                {
                    result = data;
                },
                error: function(req, status, err)
                {
                    result = "['_'] " + status;
                }
             });
        }
        catch (error)
        {
            result = "[*_*] " + error;
        }
        return result;
    }

    //$("body").layout({ applyDefaultStyles: true });
    $("body").layout();
    
});
</scriptx>
</head>
<body>

<div class="ui-layout-center">
<div id="codearea">
<textarea id="codeeditor">
// **********************************************
// ***** Welcome to the HyperApp Workbench! *****
// **********************************************
// 
// HyperApp is a programming tool for mobile development. The text in this
// window is JavaScript code that can run on your device.
//
1 + 3
22 * 99 - 7
function twice(n) { return n * 2; }
twice(22)
</textarea>
</div>
</div>

<div class="ui-layout-south">
<div id="toolbar">
<input value="Evaluate Selection" class="buttonRun" type="button" />
<input value="Run File" class="buttonRunActivity" type="button" />
<input value="Indent Selection" class="buttonIndentSelection" type="button" />
<input value="Undo" class="buttonUndo" type="button" />
<input value="Redo" class="buttonRedo" type="button" />
<input value="Clear result area" class="buttonClearResult" type="button" />
</div>
<div id="resultarea">
<textarea id="resulteditor" >
</textarea>
</div>

</div>
</body>
</html>
